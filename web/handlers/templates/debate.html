{{template "base" .}}

{{define "title"}}{{.Debate.Topic}} - dbate{{end}}

{{define "content"}}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center space-x-2">
                    <h1 class="text-xl font-bold text-gray-900">{{.Debate.Topic}}</h1>
                    {{if .Debate.ReadOnly}}
                    <span class="text-yellow-600" title="Read-only">üîí</span>
                    {{end}}
                </div>
                <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                    <span class="px-2 py-1 rounded-full text-xs font-medium {{statusColor .Debate.Status}}">
                        {{.Debate.Status}}
                    </span>
                    <span>Style: <strong class="capitalize">{{.Debate.Style}}</strong></span>
                    <span>Mode: <strong class="capitalize">{{.Debate.Mode}}</strong></span>
                    <span>Turns: {{len .Turns}}/{{.Debate.TotalTurns}}</span>
                </div>
            </div>
            <div class="flex space-x-2">
                <!-- Export dropdown -->
                {{if eq .Debate.Status "completed"}}
                <div class="relative" x-data="{ open: false }">
                    <button
                        onclick="this.nextElementSibling.classList.toggle('hidden')"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                    >
                        Export
                        <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border">
                        <a href="/debates/{{.Debate.ID}}/export/markdown" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            üìù Markdown
                        </a>
                        <a href="/debates/{{.Debate.ID}}/export/pdf" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            üìÑ PDF
                        </a>
                        <a href="/debates/{{.Debate.ID}}/export/json" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            üìä JSON
                        </a>
                    </div>
                </div>
                {{end}}

                {{if eq .Debate.Status "pending"}}
                <button
                    hx-post="/debates/{{.Debate.ID}}/run"
                    hx-swap="none"
                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"
                >
                    Run Debate
                </button>
                {{end}}
                {{if or (eq .Debate.Status "pending") (eq .Debate.Status "in_progress")}}
                <button
                    hx-post="/debates/{{.Debate.ID}}/next"
                    hx-target="#turns-container"
                    hx-swap="innerHTML"
                    hx-indicator="#next-spinner"
                    class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                >
                    <span id="next-spinner" class="htmx-indicator mr-2">
                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </span>
                    Next Turn
                </button>
                {{end}}

                <!-- Lock/Unlock -->
                {{if not .Debate.ReadOnly}}
                <button
                    hx-post="/debates/{{.Debate.ID}}/lock"
                    hx-swap="none"
                    hx-confirm="Lock this debate? It will become read-only."
                    class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                    title="Lock debate"
                >
                    üîì
                </button>
                {{else}}
                <button
                    hx-post="/debates/{{.Debate.ID}}/unlock"
                    hx-swap="none"
                    class="inline-flex items-center px-3 py-2 border border-yellow-300 text-sm font-medium rounded-md text-yellow-700 bg-yellow-50 hover:bg-yellow-100"
                    title="Unlock debate"
                >
                    üîí
                </button>
                {{end}}

                {{if not .Debate.ReadOnly}}
                <button
                    hx-delete="/debates/{{.Debate.ID}}"
                    hx-confirm="Are you sure you want to delete this debate?"
                    class="inline-flex items-center px-3 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50"
                >
                    Delete
                </button>
                {{end}}
            </div>
        </div>

        <!-- Agents -->
        <div class="mt-4 grid grid-cols-2 gap-4">
            <div class="border rounded-lg p-3 bg-blue-50">
                <div class="font-medium text-gray-900">{{.Debate.AgentA.Name}}</div>
                <div class="text-sm text-gray-500">
                    {{.Debate.AgentA.Provider}}{{if .Debate.AgentA.Model}}/{{.Debate.AgentA.Model}}{{end}} ¬∑ {{.Debate.AgentA.Persona}}
                </div>
            </div>
            <div class="border rounded-lg p-3 bg-green-50">
                <div class="font-medium text-gray-900">{{.Debate.AgentB.Name}}</div>
                <div class="text-sm text-gray-500">
                    {{.Debate.AgentB.Provider}}{{if .Debate.AgentB.Model}}/{{.Debate.AgentB.Model}}{{end}} ¬∑ {{.Debate.AgentB.Persona}}
                </div>
            </div>
        </div>
    </div>

    <!-- Turns -->
    <div
        id="turns-container"
        {{if eq .Debate.Status "in_progress"}}
        hx-get="/partials/debate/{{.Debate.ID}}/turns"
        hx-trigger="every 5s"
        hx-swap="innerHTML"
        class="polling border-2 border-blue-300 rounded-lg"
        {{end}}
    >
        {{template "turns-content" .}}
    </div>

    <!-- Conclusion -->
    {{if .Debate.Conclusion}}
    <div class="bg-white shadow-sm rounded-lg p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4">
            {{if .Debate.Conclusion.Agreed}}
            ü§ù Conclusion - Consensus Reached
            {{else}}
            ‚öîÔ∏è Conclusion - No Consensus
            {{end}}
        </h2>

        <!-- Voting Results -->
        {{if or .Debate.Conclusion.AgentAVote .Debate.Conclusion.AgentBVote}}
        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Voting Results</h3>
            <div class="grid grid-cols-2 gap-4">
                {{if .Debate.Conclusion.AgentAVote}}
                <div class="flex items-center space-x-2">
                    {{if .Debate.Conclusion.AgentAVote.Agrees}}
                    <span class="text-green-600">‚úÖ</span>
                    {{else}}
                    <span class="text-red-600">‚ùå</span>
                    {{end}}
                    <span class="text-sm">{{$.Debate.AgentA.Name}}: {{if .Debate.Conclusion.AgentAVote.Agrees}}Agrees{{else}}Disagrees{{end}}</span>
                </div>
                {{end}}
                {{if .Debate.Conclusion.AgentBVote}}
                <div class="flex items-center space-x-2">
                    {{if .Debate.Conclusion.AgentBVote.Agrees}}
                    <span class="text-green-600">‚úÖ</span>
                    {{else}}
                    <span class="text-red-600">‚ùå</span>
                    {{end}}
                    <span class="text-sm">{{$.Debate.AgentB.Name}}: {{if .Debate.Conclusion.AgentBVote.Agrees}}Agrees{{else}}Disagrees{{end}}</span>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <div class="prose max-w-none">
            <p class="text-gray-700">{{.Debate.Conclusion.Summary}}</p>

            {{if not .Debate.Conclusion.Agreed}}
            {{if .Debate.Conclusion.AgentASummary}}
            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                <h4 class="font-medium text-gray-900">{{.Debate.AgentA.Name}}'s Position:</h4>
                <p class="text-gray-700 mt-1">{{.Debate.Conclusion.AgentASummary}}</p>
            </div>
            {{end}}
            {{if .Debate.Conclusion.AgentBSummary}}
            <div class="mt-4 p-4 bg-green-50 rounded-lg">
                <h4 class="font-medium text-gray-900">{{.Debate.AgentB.Name}}'s Position:</h4>
                <p class="text-gray-700 mt-1">{{.Debate.Conclusion.AgentBSummary}}</p>
            </div>
            {{end}}
            {{end}}
        </div>
    </div>
    {{end}}
</div>
{{end}}

{{define "turns-content"}}
{{if not .Turns}}
<div class="bg-white shadow-sm rounded-lg p-12 text-center">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
    <h3 class="mt-2 text-sm font-medium text-gray-900">No turns yet</h3>
    <p class="mt-1 text-sm text-gray-500">Click "Run Debate" or "Next Turn" to start.</p>
</div>
{{else}}
<div class="space-y-4">
    {{range .Turns}}
    <div class="bg-white shadow-sm rounded-lg p-6 {{if eq .AgentID $.Debate.AgentA.ID}}border-l-4 border-blue-500{{else}}border-l-4 border-green-500{{end}}">
        <div class="flex justify-between items-start mb-3">
            <div>
                <span class="font-medium text-gray-900">
                    {{if eq .AgentID $.Debate.AgentA.ID}}
                    {{$.Debate.AgentA.Name}}
                    {{else}}
                    {{$.Debate.AgentB.Name}}
                    {{end}}
                </span>
                <span class="text-gray-500 text-sm ml-2">Turn {{.Number}}</span>
            </div>
            <span class="text-xs text-gray-400">{{formatTime .CreatedAt}}</span>
        </div>
        <div class="turn-content text-gray-700">{{nl2br .Content}}</div>
    </div>
    {{end}}
</div>
{{end}}
{{end}}
